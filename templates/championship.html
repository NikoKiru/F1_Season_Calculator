{% extends "base.html" %}

{% block title %}Championship {{ data.championship_id }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
    <div class="breadcrumbs-container">
        <ol class="breadcrumb-list">
            <li class="breadcrumb-item"><a href="{{ url_for('views.index') }}" class="breadcrumb-link">Home</a></li>
            <li class="breadcrumb-item"><span class="breadcrumb-current">Championship #{{ data.championship_id }}</span></li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="data-container">
    {% if data %}
        <!-- Modern Championship Info Section -->
        <div class="championship-hero">
            <div class="championship-winner-section">
                <div class="winner-trophy">üèÜ</div>
                <div class="winner-info">
                    <span class="winner-label">Champion</span>
                    <div class="winner-name">
                        <span class="color-bar" style="background-color: {{ drivers[data.winner].color if data.winner in drivers else '#666' }};"></span>
                        <a href="{{ url_for('views.driver_page', driver_code=data.winner) }}">{{ drivers[data.winner].name if data.winner in drivers else data.winner }}</a>
                    </div>
                    <span class="winner-team">{{ drivers[data.winner].team if data.winner in drivers else '' }}</span>
                </div>
            </div>
            <div class="championship-stats">
                <div class="championship-stat">
                    <span class="stat-number">{{ data.num_races }}</span>
                    <span class="stat-label">Races</span>
                </div>
                <div class="championship-stat">
                    <span class="stat-number">{{ data.round_points_data[data.winner].total_points if data.round_points_data and data.winner in data.round_points_data else '‚Äî' }}</span>
                    <span class="stat-label">Points</span>
                </div>
            </div>
        </div>

        <div class="rounds-section">
            <h4 class="rounds-title">Rounds Included</h4>
            <div class="rounds-chips">
                {% for round_name in data.round_names %}
                    <span class="round-chip">{{ round_name }}</span>
                {% endfor %}
            </div>
        </div>

        {% if data.round_points_data %}
        <h3 style="margin-top: 20px;">Championship Points Table:</h3>
        <div class="table-wrapper">
            <table class="standings-table">
                <thead>
                    <tr>
                        <th>Driver</th>
                        <th>Total Points</th>
                        {% for round_name in data.round_names %}
                            <th>{{ round_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for driver_code in data.standings.split(',') %}
                        {% if data.round_points_data[driver_code] %}
                            <tr>
                                <td class="driver-cell" data-label="Driver">
                                    <span class="color-bar" style="background-color: {{ drivers[driver_code].color if driver_code in drivers else '#666' }};"></span>
                                    <a href="{{ url_for('views.driver_page', driver_code=driver_code) }}">{{ data.driver_names[driver_code] }}</a>
                                </td>
                                <td data-label="Total Points"><strong>{{ data.round_points_data[driver_code].total_points }}</strong></td>
                                {% for point in data.round_points_data[driver_code].round_points %}
                                    <td data-label="{{ data.round_names[loop.index0] }}">{{ point }}</td>
                                {% endfor %}
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h3 style="margin-top: 30px;">Season Progression</h3>
        <div class="chart-container">
            <canvas id="progression-chart"></canvas>
        </div>
        {% endif %}
    {% else %}
        <p>Championship not found.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if data and data.round_points_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from template
    const roundNames = {{ data.round_names | tojson }};
    const standings = {{ data.standings.split(',') | tojson }};
    const roundPointsData = {{ data.round_points_data | tojson }};
    const driversInfo = {{ drivers | tojson }};

    // Get top 5 drivers
    const top5Drivers = standings.slice(0, 5);

    // Build datasets for each driver
    const datasets = [];

    // Group drivers by team to identify teammates
    const teamDrivers = {};
    top5Drivers.forEach(code => {
        const team = driversInfo[code]?.team || 'Unknown';
        if (!teamDrivers[team]) teamDrivers[team] = [];
        teamDrivers[team].push(code);
    });

    // Determine which driver in each team should be dashed (lower total points)
    const dashedDrivers = new Set();
    Object.values(teamDrivers).forEach(codes => {
        if (codes.length > 1) {
            // Find the teammate with lower total points
            let lowestPoints = Infinity;
            let lowestDriver = null;
            codes.forEach(code => {
                const total = roundPointsData[code]?.total_points || 0;
                if (total < lowestPoints) {
                    lowestPoints = total;
                    lowestDriver = code;
                }
            });
            if (lowestDriver) dashedDrivers.add(lowestDriver);
        }
    });

    // Create datasets
    top5Drivers.forEach(driverCode => {
        const driverData = roundPointsData[driverCode];
        if (!driverData) return;

        // Calculate cumulative points
        const cumulativePoints = [];
        let runningTotal = 0;
        driverData.round_points.forEach(points => {
            runningTotal += points;
            cumulativePoints.push(runningTotal);
        });

        const color = driversInfo[driverCode]?.color || '#666';
        const driverName = driversInfo[driverCode]?.name || driverCode;
        const isDashed = dashedDrivers.has(driverCode);

        datasets.push({
            label: driverName,
            data: cumulativePoints,
            borderColor: color,
            backgroundColor: color,
            borderWidth: 2,
            borderDash: isDashed ? [5, 5] : [],
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.1,
            fill: false
        });
    });

    // Create chart
    const ctx = document.getElementById('progression-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: roundNames,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} pts`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cumulative Points'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Round'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}