name: CD - Staging

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip CI checks (use with caution)'
        required: false
        default: 'false'
        type: boolean

env:
  ENVIRONMENT: staging

jobs:
  # Wait for CI to pass (unless skipped)
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.sha }}
          check-name: 'Build Package'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [wait-for-ci]
    if: always() && (needs.wait-for-ci.result == 'success' || github.event.inputs.skip_tests == 'true')
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create deployment info
        run: |
          echo "DEPLOY_SHA=${{ github.sha }}" > deploy-info.txt
          echo "DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> deploy-info.txt
          echo "DEPLOY_ENV=staging" >> deploy-info.txt
          echo "DEPLOY_ACTOR=${{ github.actor }}" >> deploy-info.txt

      # ================================================
      # DEPLOYMENT STEP - Customize for your platform
      # ================================================
      # Uncomment and configure ONE of the following sections
      # based on your deployment target:

      # --- OPTION 1: Railway ---
      # - name: Deploy to Railway
      #   uses: berviantoleo/railway-deploy@v1.0.0
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: f1-calculator-staging

      # --- OPTION 2: Heroku ---
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: f1-calculator-staging
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}

      # --- OPTION 3: Render ---
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_STAGING }}

      # --- OPTION 4: Docker + Cloud Run ---
      # - name: Build and push Docker image
      #   run: |
      #     docker build -t gcr.io/${{ secrets.GCP_PROJECT }}/f1-calculator:${{ github.sha }} .
      #     docker push gcr.io/${{ secrets.GCP_PROJECT }}/f1-calculator:${{ github.sha }}
      # - name: Deploy to Cloud Run
      #   uses: google-github-actions/deploy-cloudrun@v2
      #   with:
      #     service: f1-calculator-staging
      #     image: gcr.io/${{ secrets.GCP_PROJECT }}/f1-calculator:${{ github.sha }}

      # --- OPTION 5: Generic SSH Deploy ---
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     script: |
      #       cd /var/www/f1-calculator
      #       git pull origin main
      #       pip install -r requirements.txt
      #       sudo systemctl restart f1-calculator

      - name: Deployment placeholder
        id: deploy
        run: |
          echo "::notice::Staging deployment step - configure your deployment target above"
          echo "url=https://staging.example.com" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging..."
          # Add actual smoke tests here:
          # curl -f ${{ steps.deploy.outputs.url }}/api/data || exit 1
          # curl -f ${{ steps.deploy.outputs.url }}/apidocs/ || exit 1

      - name: Notify on success
        if: success()
        run: |
          echo "::notice::Successfully deployed to staging"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Staging deployment failed"
