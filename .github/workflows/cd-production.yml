name: CD - Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.2.3)'
        required: true
        type: string
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

env:
  ENVIRONMENT: production

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Validate confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "::error::Deployment not confirmed. Please type 'deploy' to confirm."
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format. Use semantic versioning (e.g., v1.2.3)"
            exit 1
          fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.proceed == 'true'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Verify tag exists
        run: |
          git fetch --tags
          if ! git tag -l | grep -q "^${{ github.event.inputs.version }}$"; then
            echo "::error::Tag ${{ github.event.inputs.version }} not found"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pre-deployment checks
        run: |
          echo "Running pre-deployment validation..."
          pip install pytest
          pytest tests/ -v --tb=short

      - name: Create deployment record
        run: |
          echo "DEPLOY_VERSION=${{ github.event.inputs.version }}" > deploy-info.txt
          echo "DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> deploy-info.txt
          echo "DEPLOY_ENV=production" >> deploy-info.txt
          echo "DEPLOY_ACTOR=${{ github.actor }}" >> deploy-info.txt
          echo "DEPLOY_APPROVED_BY=${{ github.actor }}" >> deploy-info.txt

      # ================================================
      # DEPLOYMENT STEP - Customize for your platform
      # ================================================
      # Same options as staging - uncomment your platform:

      # --- OPTION 1: Railway ---
      # - name: Deploy to Railway
      #   uses: berviantoleo/railway-deploy@v1.0.0
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: f1-calculator-production

      # --- OPTION 2: Heroku ---
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: f1-calculator-production
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}

      - name: Deployment placeholder
        id: deploy
        run: |
          echo "::notice::Production deployment step - configure your deployment target"
          echo "url=https://f1calculator.example.com" >> $GITHUB_OUTPUT

      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add comprehensive production tests:
          # curl -f ${{ steps.deploy.outputs.url }}/ || exit 1
          # curl -f ${{ steps.deploy.outputs.url }}/api/data || exit 1
          # curl -f ${{ steps.deploy.outputs.url }}/apidocs/ || exit 1

      - name: Create deployment summary
        if: success()
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Production deployment failed for version ${{ github.event.inputs.version }}"

  rollback-instructions:
    name: Rollback Instructions
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: Show rollback instructions
        run: |
          echo "## Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If you need to rollback this deployment:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions > CD - Production" >> $GITHUB_STEP_SUMMARY
          echo "2. Click 'Run workflow'" >> $GITHUB_STEP_SUMMARY
          echo "3. Enter the previous version tag" >> $GITHUB_STEP_SUMMARY
          echo "4. Type 'deploy' to confirm" >> $GITHUB_STEP_SUMMARY
